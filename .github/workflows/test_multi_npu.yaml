name: 'multi_npu_test'

on:
  workflow_dispatch:
    inputs:
      runner:
        required: true
        type: choice
        options:
          - linux-arm64-npu-4
        default: 'linux-arm64-npu-4'
        description: 'The runner selected to run on'
      image:
        required: true
        type: choice
        options:
          - quay.io/ascend/cann:8.0.0-910b-ubuntu22.04-py3.10
          - ascendai/cann:8.0.0-910b-ubuntu22.04-py3.10
        default: 'ascendai/cann:8.0.0-910b-ubuntu22.04-py3.10'
        description: 'The docker image which will be loaded'


# Bash shells do not use ~/.profile or ~/.bashrc so these shells need to be explicitly
# declared as "shell: bash -el {0}" on steps that need to be properly activated.
# It's used to activate ascend-toolkit environment variables.
defaults:
  run:
    shell: bash -el {0}

jobs:
  test:
    name: run benchmarks for torch_npu
    runs-on: ${{ github.event.inputs.runner || 'linux-arm64-npu-4' }}
    container:
      image: ${{ github.event.inputs.image || 'ascendai/cann:latest' }}
      env:
        HF_ENDPOINT: https://hf-mirror.com
        VLLM_USE_MODELSCOPE: true
    steps:
      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Check env var
        run: |
          echo ${SHAREGPT_PATH}
          echo ${LLAMA_3_1_8B_PATH}
          echo ${RESULTS_FOLDER}
          echo $ES_OM_DOMAIN
          echo $ES_OM_AUTHORIZATION

      - name: Config mirrors
        run: |
          # sed -i 's|ports.ubuntu.com|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list
          pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

      - name: Install system dependencies
        run: |
          apt-get update -y
          apt-get -y install git jq wget curl
      
      - name: Download model
        run: |
          echo $HF_ENDPOINT
          huggingface-cli download --resume-download deepseek-ai/DeepSeek-V2-Lite
          huggingface-cli download --resume-download Qwen/QwQ-32B
          huggingface-cli download --resume-download meta-llama/Llama-3.1-8B-Instruct 
