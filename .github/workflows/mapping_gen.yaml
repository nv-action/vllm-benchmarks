name: 'Generate test mapping'

on:
  pull_request:
  push:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image URL'
        required: true
        default: 'swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-a3-ubuntu22.04-py3.11'
  schedule:
    - cron: '0 0 * * *'  # 每日零点

env:
  VLLM_LOGGING_LEVEL: ERROR
  VLLM_USE_MODELSCOPE: True
  HF_HUB_OFFLINE: 1
  PYTORCH_NPU_ALLOC_CONF: max_split_size_mb:256
  VLLM_WORKER_MULTIPROC_METHOD: spawn
  ENABLE_MAPPING_GEN: "1"

jobs:
  generate-mapping-singlecard:
    name: singlecard-mapping
    runs-on: linux-aarch64-a2-1
    container:
      image: ${{ github.event.inputs.image || 'swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-a3-ubuntu22.04-py3.11' }}
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-full with coverage
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-singlecard \
            --auto-partition-size 2 \
            --auto-partition-id 0

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-singlecard
          path: .coverage.*

  generate-mapping-2card:
    name: 2card-mapping
    runs-on: linux-aarch64-a3-2
    container:
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-a3-ubuntu22.04-py3.11
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-2-card-full with coverage
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-multicard-2-cards \
            --auto-partition-size 1 \
            --auto-partition-id 0

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-2card
          path: .coverage.*

  generate-mapping-4card:
    name: 4card-mapping
    runs-on: linux-aarch64-a3-4
    container:
      image: m.daocloud.io/quay.io/ascend/cann:8.5.0-a3-ubuntu22.04-py3.11
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-4-card-full with coverage
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-multicard-4-cards \
            --auto-partition-size 1 \
            --auto-partition-id 0

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-4card
          path: .coverage.*

  merge-mapping:
    needs: [generate-mapping-singlecard, generate-mapping-2card, generate-mapping-4card]
    name: merge-mapping
    runs-on: linux-aarch64-a2b3-1
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          path: coverage-data

      - name: Combine coverage data
        run: |
          # Move all .coverage files to current directory
          find coverage-data -name ".coverage.*" -exec mv {} . \; 2>/dev/null || true
          coverage combine

      - name: Generate mapping
        run: |
          python3 .github/workflows/scripts/gen_mapping.py

      - name: Upload mapping artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-mapping
          path: mapping_*.json
