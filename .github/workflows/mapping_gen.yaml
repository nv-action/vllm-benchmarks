name: 'Generate test mapping'

on:
  pull_request:
  push:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image URL for singlecard'
        required: true
        default: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
  schedule:
    - cron: '0 0 * * *'  # 每日零点

# Container jobs may fall back to /bin/sh if not specified; we need bash features.
defaults:
  run:
    shell: bash

env:
  # Suppress noisy Node.js deprecation warnings from JS-based actions.
  NODE_OPTIONS: --no-deprecation

jobs:
  generate-mapping-singlecard:
    name: singlecard-mapping
    runs-on: linux-aarch64-a2-1
    strategy:
      fail-fast: false
      matrix:
        part: [0, 1]
    container:
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      env:
        VLLM_LOGGING_LEVEL: ERROR
        VLLM_USE_MODELSCOPE: True
        HF_HUB_OFFLINE: 1
        ENABLE_MAPPING_GEN: "1"
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          ref: 9562912cead1f11e8540fb91306c5cbda66f0007
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-full with coverage
        env:
          VLLM_WORKER_MULTIPROC_METHOD: spawn
          PYTORCH_NPU_ALLOC_CONF: max_split_size_mb:256
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-singlecard \
            --auto-partition-id ${{ matrix.part }} \
            --auto-partition-size 2

      - name: Stage coverage files to /tmp
        run: |
          set -eu
          set -o pipefail 2>/dev/null || true
          ls -la .coverage*
          mkdir -p /tmp/vllm-ascend-mapping/coverage/singlecard/part-${{ matrix.part }}
          # Use .coverage* to include both .coverage and .coverage.*
          cp -a .coverage* /tmp/vllm-ascend-mapping/coverage/singlecard/part-${{ matrix.part }}/
          ls -la /tmp/vllm-ascend-mapping/coverage/singlecard/part-${{ matrix.part }} || true

      - name: Upload coverage data
        uses: actions/upload-artifact@v6
        with:
          name: coverage-singlecard-${{ matrix.part }}
          path: /tmp/vllm-ascend-mapping/coverage/singlecard/part-${{ matrix.part }}/.coverage*
          retention-days: 7

  generate-mapping-2card:
    name: 2card-mapping
    runs-on: linux-aarch64-a3-2
    strategy:
      fail-fast: false
      matrix:
        part: [0]
    container:
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      env:
        VLLM_LOGGING_LEVEL: ERROR
        VLLM_USE_MODELSCOPE: True
        HCCL_BUFFSIZE: 1024
        HF_HUB_OFFLINE: 1
        ENABLE_MAPPING_GEN: "1"
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          ref: 9562912cead1f11e8540fb91306c5cbda66f0007
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-2-card-full with coverage
        env:
          VLLM_WORKER_MULTIPROC_METHOD: spawn
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-multicard-2-cards \
            --auto-partition-id ${{ matrix.part }} \
            --auto-partition-size 1

      - name: Run vllm-project/vllm-ascend test (non triton)
        env:
          VLLM_WORKER_MULTIPROC_METHOD: spawn
        run: |
          python3 -m pip uninstall -y triton-ascend
          pytest -sv --durations=0 tests/e2e/multicard/2-cards/test_aclgraph_capture_replay.py

      - name: Stage coverage files to /tmp
        run: |
          set -eu
          set -o pipefail 2>/dev/null || true
          ls -la .coverage*
          mkdir -p /tmp/vllm-ascend-mapping/coverage/2card
          cp -a .coverage* /tmp/vllm-ascend-mapping/coverage/2card/
          ls -la /tmp/vllm-ascend-mapping/coverage/2card || true

      - name: Upload coverage data
        uses: actions/upload-artifact@v6
        with:
          name: coverage-2card
          path: /tmp/vllm-ascend-mapping/coverage/2card/.coverage*
          retention-days: 7

  generate-mapping-4card:
    name: 4card-mapping
    runs-on: linux-aarch64-a3-4
    strategy:
      fail-fast: false
      matrix:
        part: [0]
    container:
      image: m.daocloud.io/quay.io/ascend/cann:8.5.0-a3-ubuntu22.04-py3.11
      env:
        VLLM_LOGGING_LEVEL: ERROR
        VLLM_USE_MODELSCOPE: True
        HF_HUB_OFFLINE: 1
        ENABLE_MAPPING_GEN: "1"
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Check npu and CANN info
        run: |
          npu-smi info
          cat /usr/local/Ascend/ascend-toolkit/latest/"$(uname -i)"-linux/ascend_toolkit_install.info

      - name: Config mirrors
        run: |
          sed -Ei 's@(ports|archive).ubuntu.com@cache-service.nginx-pypi-cache.svc.cluster.local:8081@g' /etc/apt/sources.list
          pip config set global.index-url http://cache-service.nginx-pypi-cache.svc.cluster.local/pypi/simple
          pip config set global.trusted-host cache-service.nginx-pypi-cache.svc.cluster.local
          apt-get update -y
          apt install git -y

      - name: Install system dependencies
        run: |
          apt-get -y install `cat packages.txt`
          apt-get -y install gcc g++ cmake libnuma-dev clang-15
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 20
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 20

      - name: Checkout vllm-project/vllm repo
        uses: actions/checkout@v6
        with:
          repository: vllm-project/vllm
          ref: 9562912cead1f11e8540fb91306c5cbda66f0007
          path: ./vllm-empty
          fetch-depth: 1

      - name: Install vllm-project/vllm from source
        working-directory: ./vllm-empty
        run: |
          VLLM_TARGET_DEVICE=empty pip install -e .

      - name: Install vllm-project/vllm-ascend
        env:
          PIP_EXTRA_INDEX_URL: https://mirrors.huaweicloud.com/ascend/repos/pypi
        run: |
          pip install pytest-cov coverage tabulate
          pip install -r requirements-dev.txt
          pip install -v -e .

      - name: Run e2e-4-card-full with coverage
        env:
          VLLM_WORKER_MULTIPROC_METHOD: spawn
        run: |
          python3 .github/workflows/scripts/run_suite.py \
            --suite e2e-multicard-4-cards \
            --auto-partition-id ${{ matrix.part }} \
            --auto-partition-size 1

      - name: Stage coverage files to /tmp
        run: |
          set -eu
          set -o pipefail 2>/dev/null || true
          ls -la .coverage*
          mkdir -p /tmp/vllm-ascend-mapping/coverage/4card
          cp -a .coverage* /tmp/vllm-ascend-mapping/coverage/4card/
          ls -la /tmp/vllm-ascend-mapping/coverage/4card || true

      - name: Upload coverage data
        uses: actions/upload-artifact@v6
        with:
          name: coverage-4card
          path: /tmp/vllm-ascend-mapping/coverage/4card/.coverage*
          retention-days: 7

  merge-mapping:
    needs: [generate-mapping-singlecard, generate-mapping-2card, generate-mapping-4card]
    name: merge-mapping
    runs-on: linux-aarch64-a2-1
    steps:
      - name: Checkout vllm-project/vllm-ascend repo
        uses: actions/checkout@v6

      - name: Install coverage
        run: |
          python3 -m pip install -U pip
          python3 -m pip install -U coverage

      - name: Download all coverage data
        uses: actions/download-artifact@v6
        with:
          pattern: coverage-*
          path: /tmp/vllm-ascend-mapping/coverage-data
          merge-multiple: true

      - name: Combine coverage data
        run: |
          set -eu
          set -o pipefail 2>/dev/null || true
          ls -la /tmp/vllm-ascend-mapping/coverage-data/ || true
          mkdir -p /tmp/vllm-ascend-mapping/coverage-flat
          find /tmp/vllm-ascend-mapping/coverage-data -type f -name '.coverage*' -exec cp -a {} /tmp/vllm-ascend-mapping/coverage-flat/ \;
          ls -la /tmp/vllm-ascend-mapping/coverage-flat/ || true
          coverage combine /tmp/vllm-ascend-mapping/coverage-flat
          ls -la .coverage* || true

      - name: Generate mapping
        run: |
          python3 .github/workflows/scripts/gen_mapping.py

      - name: Stage mapping json to /tmp
        run: |
          set -eu
          set -o pipefail 2>/dev/null || true
          mkdir -p /tmp/vllm-ascend-mapping/output
          cp -a mapping_*.json /tmp/vllm-ascend-mapping/output/
          ls -la /tmp/vllm-ascend-mapping/output/

      - name: Upload mapping artifact
        uses: actions/upload-artifact@v6
        with:
          name: test-mapping
          path: /tmp/vllm-ascend-mapping/output/mapping_*.json
          retention-days: 7
