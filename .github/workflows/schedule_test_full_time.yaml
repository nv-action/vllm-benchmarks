name: Full Test Time Update

on:
  pull_request:
  push:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for the upstream PR'
        required: false
        default: "main"
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: time_update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-full:
    name: Collect stats (e2e full)
    strategy:
      matrix:
        vllm_version: [9562912cead1f11e8540fb91306c5cbda66f0007]
    uses: ./.github/workflows/_e2e_test.yaml
    with:
      vllm: ${{ matrix.vllm_version }}
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      contains_310: false
      type: full
      collect_test_stats: true

  e2e-light:
    name: Collect stats (e2e light)
    strategy:
      matrix:
        vllm_version: [9562912cead1f11e8540fb91306c5cbda66f0007]
    uses: ./.github/workflows/_e2e_test.yaml
    with:
      vllm: ${{ matrix.vllm_version }}
      image: swr.cn-southwest-2.myhuaweicloud.com/base_image/ascend-ci/cann:8.5.0-910b-ubuntu22.04-py3.11
      contains_310: false
      type: light
      collect_test_stats: true

  update-config:
    name: Merge stats, update config, create PR
    if: ${{ always() && (github.event_name != 'pull_request' || !startsWith(github.head_ref, 'auto-pr/update-test-times-')) }}
    needs: [e2e-full, e2e-light]
    runs-on: ubuntu-latest
    env:
      UPSTREAM_REPO: nv-action/vllm-benchmarks
      FORK_OWNER: MrZ20
      FORK_REPO: MrZ20/vllm-benchmarks
      TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}
      BASE_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}

    steps:
      - name: Checkout Fork Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ env.BASE_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Setup git and branch from upstream
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch || 'main' }}"
          echo "TARGET_BRANCH=${TARGET_BRANCH}" >> $GITHUB_ENV
          BRANCH_NAME="auto-pr/update-test-times-$(date +%Y%m%d%H%M%S)-${{ github.run_id }}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

          git remote set-url origin "https://x-access-token:${{ secrets.PAT_TOKEN || github.token }}@github.com/${{ env.FORK_REPO }}.git"
          git fetch origin
          git remote remove upstream || true
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git checkout -B "${BRANCH_NAME}" "origin/${TARGET_BRANCH}"

      - name: Download stats artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
          pattern: test-stats-*
          merge-multiple: true

      - name: Merge all stats JSON
        id: merge
        run: |
          python3 - <<'PY'
          import glob, json, os
          merged = []
          files = glob.glob("artifacts/**/test_stats*.json", recursive=True)
          for p in sorted(set(files)):
              with open(p, "r") as f:
                  data = json.load(f)
                  if isinstance(data, list): merged.extend(data)
          with open("test_stats.json", "w") as f:
              json.dump(merged, f, indent=2)
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"has_stats={'true' if merged else 'false'}\n")
              out.write(f"stats_count={len(merged)}\n")
          PY

      - name: Upload merged test_stats.json
        if: steps.merge.outputs.has_stats == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: merged-test-stats-${{ github.run_id }}
          path: test_stats.json
          if-no-files-found: error

      - name: Update config.yaml
        if: steps.merge.outputs.has_stats == 'true'
        run: |
          pip install ruamel.yaml
          python3 .github/workflows/scripts/update_test_times.py \
            --config .github/workflows/scripts/config.yaml \
            --stats test_stats.json

      - name: Commit and Push to Fork
        if: steps.merge.outputs.has_stats == 'true'
        id: push_step
        run: |
          git add .github/workflows/scripts/config.yaml
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git commit -s -m "ci: update e2e test estimated_time"
          # 推送到你自己的 Fork (origin)
          git push --set-upstream origin "${{ env.BRANCH_NAME }}"
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create PR to Upstream
        if: steps.push_step.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        env:
          PR_HEAD: ${{ env.FORK_OWNER }}:${{ env.BRANCH_NAME }}
          PR_BASE: ${{ env.TARGET_BRANCH }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          STATS_COUNT: ${{ steps.merge.outputs.stats_count }}
          ARTIFACT_NAME: merged-test-stats-${{ github.run_id }}
        with:
          github-token: ${{ secrets.PAT_TOKEN || github.token }}
          script: |
            try {
              const [owner, repo] = process.env.UPSTREAM_REPO.split('/');
              const prBody = '## Auto-Update Summary\n\n' +
                '- Updated config: `.github/workflows/scripts/config.yaml`\n' +
                '- Merged stats records: **' + (process.env.STATS_COUNT || '0') + '**\n' +
                '- Artifact: `' + process.env.ARTIFACT_NAME + '`\n\n' +
                '[Workflow Run](' + process.env.RUN_URL + ')';
              const pr = await github.rest.pulls.create({
                owner: owner,
                repo: repo,
                head: process.env.PR_HEAD, // 格式: "MrZ20:branch-name"
                base: process.env.PR_BASE,
                title: "[CI] Update E2E Test Estimated Time",
                body: prBody
              });
              core.info(`Created Upstream PR #${pr.data.number}`);
            } catch (error) {
              if (error.message.includes('A pull request already exists')) {
                core.warning('PR already exists');
              } else {
                throw error;
              }
            }
