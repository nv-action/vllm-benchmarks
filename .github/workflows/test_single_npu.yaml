name: 'single_npu_test'

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
        description: 'The runner selected to run on'
      image:
        required: true
        type: string
        description: 'The docker image which will be loaded'

# Bash shells do not use ~/.profile or ~/.bashrc so these shells need to be explicitly
# declared as "shell: bash -el {0}" on steps that need to be properly activated.
# It's used to activate ascend-toolkit environment variables.
defaults:
  run:
    shell: bash -el {0}

jobs:
  test:
    name: run benchmarks for torch_npu
    runs-on: ${{ inputs.runner }}
    container:
      image: ${{ inputs.image }}
      env:
        HF_ENDPOINT: https://hf-mirror.com
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - name: Show NPU info
        run: |
          npu-smi info
      - name: Check env
        run: |
          echo "hf_endpoint: $HF_ENDPOINT"
          echo "hf_token: $HF_TOKEN"
                  
      - name: Config mirrors
        run: |
          sed -i 's|ports.ubuntu.com|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list
          pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

      - name: Install huggingface-cli
        run: |
          pip install huggingface-hub[cli]
      
      - name: Download model
        run: |
          echo $HF_TOKEN
          huggingface-cli download --resume-download meta-llama/Meta-Llama-3.1-8B-Instruct --token $HF_TOKEN --exclude "*.pth"