FROM quay.nju.edu.cn/ascend/cann:8.3.rc1-a3-ubuntu22.04-py3.11

# ---------------------------------------------------------------------
# ARG & ENV
# ---------------------------------------------------------------------
ARG PIP_INDEX_URL="https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple"
ARG COMPILE_CUSTOM_KERNELS=1
ARG VLLM_WORKSPACE="/vllm-workspace"
ARG MOONCAKE_TAG="v0.3.7.post2"
ARG VLLM_TAG="v0.11.0"

ENV DEBIAN_FRONTEND=noninteractive \
    COMPILE_CUSTOM_KERNELS=${COMPILE_CUSTOM_KERNELS}

WORKDIR /workspace

SHELL ["/bin/bash", "-c"]
# ---------------------------------------------------------------------
# Setup pip
# ---------------------------------------------------------------------
RUN pip config set global.index-url ${PIP_INDEX_URL}

COPY ./mooncake_installer.sh ./mooncake_installer.sh

# Install mooncake
RUN chmod +x ./mooncake_installer.sh && \
    ./mooncake_installer.sh ${MOONCAKE_TAG}

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    git vim wget net-tools gcc g++ cmake && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# Install vLLM
RUN git clone -b $VLLM_TAG --depth 1 https://github.com/vllm-project/vllm.git  $VLLM_WORKSPACE/vllm && \
    VLLM_TARGET_DEVICE="empty" pip3 install -v -e $VLLM_WORKSPACE/vllm/ \
        --extra-index-url https://download.pytorch.org/whl/cpu/ && \
    pip3 uninstall -y triton


CMD ["/bin/bash"]
