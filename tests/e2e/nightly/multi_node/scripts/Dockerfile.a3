FROM quay.io/ascend/cann:8.2.rc1-a3-ubuntu22.04-py3.11

# ---------------------------------------------------------------------
# ARG & ENV
# ---------------------------------------------------------------------
ARG PIP_INDEX_URL="https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple"
ARG COMPILE_CUSTOM_KERNELS=1
ARG VLLM_REPO="https://github.com/vllm-project/vllm.git"
ARG VLLM_TAG="v0.11.0"
ARG MOONCAKE_REPO="https://github.com/AscendTransport/Mooncake"
ARG MOONCAKE_BRANCH="pooling_async_memecpy_v1"
ARG MOONCAKE_COMMIT="8fce1ffab3930fec2a8b8d3be282564dfa1bb186"
ARG AIS_BENCH_REPO="https://gitee.com/aisbench/benchmark.git"
ARG AIS_BENCH_TAG="v3.0-20250930-master"

ENV DEBIAN_FRONTEND=noninteractive \
    COMPILE_CUSTOM_KERNELS=${COMPILE_CUSTOM_KERNELS} \
    WORKDIR=/workspace \
    LD_LIBRARY_PATH=/usr/local/Ascend/ascend-toolkit/latest/python/site-packages:$LD_LIBRARY_PATH \
    CPATH=/usr/lib/aarch64-linux-gnu/mpich/include:/usr/lib/aarch64-linux-gnu/openmpi/lib

WORKDIR $WORKDIR

SHELL ["/bin/bash", "-c"]

# ---------------------------------------------------------------------
# Install system dependencies
# ---------------------------------------------------------------------
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    python3-pip git vim wget net-tools gcc g++ cmake libnuma-dev && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# ---------------------------------------------------------------------
# Setup pip
# ---------------------------------------------------------------------
RUN pip config set global.index-url ${PIP_INDEX_URL}

# ---------------------------------------------------------------------
# Install vLLM
# ---------------------------------------------------------------------
RUN git clone --depth 1 ${VLLM_REPO} --branch ${VLLM_TAG} /vllm-workspace/vllm && \
    VLLM_TARGET_DEVICE="empty" python3 -m pip install -v -e /vllm-workspace/vllm/ \
        --extra-index-url https://download.pytorch.org/whl/cpu/ && \
    python3 -m pip uninstall -y triton && \
    python3 -m pip cache purge

# ---------------------------------------------------------------------
# Install Mooncake
# ---------------------------------------------------------------------
RUN git clone -b ${MOONCAKE_BRANCH} --depth 1 ${MOONCAKE_REPO} && \
    cd Mooncake && \
    git checkout ${MOONCAKE_COMMIT} && \
    sed -i 's|https://go.dev/dl/|https://golang.google.cn/dl/|g' dependencies.sh && \
    bash dependencies.sh -y && \
    apt-get purge -y mpich libmpich-dev openmpi-bin libopenmpi-dev || true && \
    apt-get install -y mpich libmpich-dev && \
    mkdir -p build && cd build && \
    cmake .. && make -j && make install && \
    cp mooncake-transfer-engine/src/transport/ascend_transport/hccl_transport/ascend_transport_c/libascend_transport_mem.so \
        /usr/local/Ascend/ascend-toolkit/latest/python/site-packages/ && \
    cp mooncake-transfer-engine/src/libtransfer_engine.so \
        /usr/local/Ascend/ascend-toolkit/latest/python/site-packages/

# ---------------------------------------------------------------------
# Install ais_bench
# ---------------------------------------------------------------------
RUN git clone -b ${AIS_BENCH_TAG} --depth 1 ${AIS_BENCH_REPO} && \
    cd benchmark && \
    pip3 install -e . && \
    pip3 install -r requirements/api.txt && \
    pip3 install -r requirements/extra.txt


CMD ["/bin/bash"]
