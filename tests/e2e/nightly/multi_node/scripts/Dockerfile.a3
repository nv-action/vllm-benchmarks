FROM quay.io/ascend/vllm-ascend:main-a3

# ---------------------------------------------------------------------
# ARG & ENV
# ---------------------------------------------------------------------
ARG PIP_INDEX_URL="https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple"
ARG VLLM_WORKSPACE="/vllm-workspace"
ARG MOONCAKE_TAG="v0.3.7.post2"
ARG AIS_BENCH_TAG="v3.0-20250930-master"

ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /workspace

SHELL ["/bin/bash", "-c"]
# ---------------------------------------------------------------------
# Setup pip
# ---------------------------------------------------------------------
RUN pip config set global.index-url ${PIP_INDEX_URL}

COPY ./mooncake_installer.sh ./mooncake_installer.sh

# Build mooncake
RUN chmod +x ./mooncake_installer.sh && \
    ./mooncake_installer.sh ${MOONCAKE_TAG}

# Install aisbench
RUN git clone -b ${AIS_BENCH_TAG} --depth 1 https://gitee.com/aisbench/benchmark.git ${VLLM_WORKSPACE}/benchmark && \
    pip3 install --no-cache-dir \
    -e ${VLLM_WORKSPACE}/benchmark \
    -r ${VLLM_WORKSPACE}/benchmark/requirements/api.txt \
    -r ${VLLM_WORKSPACE}/benchmark/requirements/extra.txt

CMD ["/bin/bash"]
