FROM quay.nju.edu.cn/ascend/cann:8.2.rc1-a3-ubuntu22.04-py3.11

# ---------------------------------------------------------------------
# ARG & ENV
# ---------------------------------------------------------------------
ARG PIP_INDEX_URL="https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple"
ARG COMPILE_CUSTOM_KERNELS=1
ARG VLLM_REPO="https://github.com/vllm-project/vllm.git"
ARG VLLM_TAG="v0.11.0"
ARG MOONCAKE_REPO="https://github.com/AscendTransport/Mooncake"
ARG MOONCAKE_BRANCH="pooling_async_memecpy_v1"
ARG MOONCAKE_COMMIT="8fce1ffab3930fec2a8b8d3be282564dfa1bb186"
ARG AIS_BENCH_REPO="https://gitee.com/aisbench/benchmark.git"
ARG AIS_BENCH_TAG="v3.0-20250930-master"
ARG VLLM_WORKSPACE="/vllm-workspace"

ENV DEBIAN_FRONTEND=noninteractive \
    COMPILE_CUSTOM_KERNELS=${COMPILE_CUSTOM_KERNELS} \
    WORKDIR=/workspace \
    LD_LIBRARY_PATH=/usr/local/Ascend/ascend-toolkit/latest/python/site-packages:$LD_LIBRARY_PATH \
    CPATH=/usr/lib/aarch64-linux-gnu/mpich/include:/usr/lib/aarch64-linux-gnu/openmpi/lib \
    GOROOT=/usr/local/go \
    PATH=$GOROOT/bin:$PATH

WORKDIR $WORKDIR

SHELL ["/bin/bash", "-c"]

# ---------------------------------------------------------------------
# Install system dependencies
# ---------------------------------------------------------------------
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    python3-pip git vim wget net-tools gcc g++ cmake libnuma-dev && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# ---------------------------------------------------------------------
# Setup pip
# ---------------------------------------------------------------------
RUN pip config set global.index-url ${PIP_INDEX_URL}

COPY ./Mooncake /vllm-workspace/Mooncake
COPY ./benchmark /vllm-workspace/benchmark
COPY ./vllm /vllm-workspace/vllm

RUN VLLM_TARGET_DEVICE="empty" python3 -m pip install -v -e $VLLM_WORKSPACE/vllm/ \
        --extra-index-url https://download.pytorch.org/whl/cpu/ && \
    python3 -m pip uninstall -y triton


RUN pip3 install --no-cache-dir -e $VLLM_WORKSPACE/benchmark -r $VLLM_WORKSPACE/benchmark/requirements/api.txt -r $VLLM_WORKSPACE/benchmark/requirements/extra.txt && \
    python3 -m pip cache purge

RUN apt update \
     && apt install -y unzip wget cmake git sudo \
     && pip install pybind11

# Execute installation in the container
RUN cd ${VLLM_WORKSPACE}/Mooncake && bash dependencies.sh \
     && apt autoremove -y \
     && apt clean -y \
     && rm -rf /tmp/* /var/tmp/* \
     && find /var/cache/apt/archives /var/lib/apt/lists -not -name lock -type f -delete \
     && find /var/cache -type f -delete

RUN cd ${VLLM_WORKSPACE}/Mooncake && rm -rf build || true \
     && mkdir build && cd build \
     && cmake .. -DSTORE_USE_ETCD=ON && make -j$(nproc) && make install

CMD ["/bin/bash"]
